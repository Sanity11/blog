services:
  - docker

language: php

php:
  - '7.0'

env:
  DOCKER_COMPOSE_VERSION: 1.8.0-rc2

before_install:
  - sudo apt-get update
  - sudo apt-get install -o Dpkg::Options::="--force-confold" --force-yes -y docker-engine
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

before_script:
  - unexpand -t 4 Makefile > Makefile.tmp && mv Makefile.tmp Makefile
  - cd app && composer install && cd ..

script:
  - phpunit -c app/phpunit.xml.dist --coverage-text
  - make build_container_image

after_failure:
  - docker logs dionsnoeijen/blog

after_success:
  - docker login --email=$DOCKER_EMAIL --username=$DOCKER_USERNAME --password=$DOCKER_PASSWORD
  - if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then docker push dionsnoeijen/blog:latest; fi
  - if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then docker push dionsnoeijen/php:latest; fi

notifications:
  email:
    - hallo@dionsnoeijen.nl